@model IEnumerable<Services.DTOs.CategoryDTO>

@{
    ViewData["Title"] = "Categories";
}

<h2>Category Management</h2>
<button id="btnCreate" class="btn btn-primary" data-toggle="modal" data-target="#modalCategory">Create Category</button>
<input type="text" id="searchBox" placeholder="Search..." class="form-control" />

<table class="table table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>Parent</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="categoryTable">
        @foreach (var category in Model)
        {
            <tr>
                <td>@category.CategoryId</td>
                <td>@category.CategoryName</td>
                <td>@category.CategoryDesciption</td>
                <td>@category.ParentCategoryName</td>
                <td>
                    <button class="btn btn-warning btnEdit" data-id="@category.CategoryId">Edit</button>
                    <button class="btn btn-danger btnDelete" data-id="@category.CategoryId">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Modal Placeholder -->
<div id="modalPlaceholder"></div>

@section Scripts {
    <script>
        $(document).ready(function() {
                    $('#btnCreate').click(function() {
            $.get("@Url.Action("Create", "Categories")", function(data) {
                $('#modalPlaceholder').html(data);
                $('#categoryModal').modal('show');
            });
        });
        $(document).ready(function () {
            $('.btnEdit').click(function () {
                let id = $(this).data('id');
                $.get("@Url.Action("Edit", "Categories")", { id: id })
                    .done(function (data) {
                        $('#modalPlaceholder').html(data); // Insert valid HTML
                        $('#categoryModal').modal('show'); // Show modal
                    })
                    .fail(function (xhr) {
                        console.error("Error: " + xhr.responseText);
                        alert("Failed to load category edit form.");
                    });
            });

            // Ensure Close button works
            $(document).on('click', '.close, .btn-secondary', function () {
                $('#categoryModal').modal('hide');
            });

            // Update action
            $(document).on('click', '#updateCategory', function () {
                $.ajax({
                    url: "@Url.Action("Edit", "Categories")",
                    type: "POST",
                    data: $('#editCategoryForm').serialize(),
                    success: function (response) {
                        if (response.success) {
                            $('#categoryModal').modal('hide'); // Close modal
                            location.reload(); // Refresh page
                        } else {
                            alert("Validation Errors: " + response.errors.join("\n"));
                        }
                    },
                    error: function (xhr) {
                        alert("Error: " + xhr.responseText);
                    }
                });
            });
        });
        $(document).ready(function () {
            // Load Delete modal
            $('.btnDelete').click(function () {
                let id = $(this).data('id');
                $.get("/Categories/Delete", { id: id }, function (data) {
                    $('#modalPlaceholder').html(data);
                    $('#deleteCategoryModal').modal('show');
                }).fail(function (xhr) {
                    alert("Error loading delete modal: " + xhr.responseText);
                });
            });

        $(document).on('click', '#confirmDelete', function () {
            let id = $('#deleteCategoryId').val();
            let token = $('input[name="__RequestVerificationToken"]').val(); // Get anti-forgery token

            console.log("Deleting category with ID:", id, "Token:", token); // Debugging

            $.ajax({
                url: "/Categories/DeleteConfirmed",
                type: "POST",
                contentType: "application/json",
                headers: {
                    "RequestVerificationToken": token // Send anti-forgery token
                },
                data: JSON.stringify({ Id: parseInt(id) }), // Fix key case (Id instead of id)
                success: function (response) {
                    if (response.success) {
                        $('#deleteCategoryModal').modal('hide');
                        location.reload();
                    } else {
                        alert("Error deleting category.");
                    }
                },
                error: function (xhr) {
                    console.error("Error:", xhr.responseText);
                    alert("Error: " + xhr.responseText);
                }
            });
        });
        });
        });
    </script>
}
